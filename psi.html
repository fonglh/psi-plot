<!DOCTYPE html>
<html>
	<head>
		<title>Singapore PSI Readings</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
		<link href="css/bootstrap-responsive.css" rel="stylesheet">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
		<script src="highstock.js"></script>
		<script src="highcharts-more.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/dateformat.min.js"></script>

		<script>
		$(function() {
			Highcharts.setOptions({
				global: {
					useUTC: false
				}
			});

			var series24hrpsi;
			//get data and prepare to add to PSI reading chart
			$.getJSON('http://cosine.dyndns-web.com/psi/psijson.php?query=psi24hr-all&callback=?', function( data ) {
				series24hrpsi = { name: 'PSI 24 hour Range', type: 'columnrange', id: 'psi24hr', data: data };
			});

			var psichart;
			var pm25chart;
			//get data and create 3 hour PSI reading chart
			$.getJSON('http://cosine.dyndns-web.com/psi/psijson.php?query=psi3hr-all&callback=?', function( data ) {
				psichart = new Highcharts.StockChart({
					chart: {
						renderTo: 'psi_container',
						events: {
							//set up updating of the chart every min
							load: function() {
								setInterval( updatePSI, 60000 );
							}
						}
					},
					rangeSelector: {
						selected: 1
					},

					legend: {
						enabled: true,
						align: 'center',
						verticalAlign: 'bottom',
						borderWidth: 2,
						itemMarginBottom: 10,
					},

					rangeSelector: {
						buttons: [
						{
							type: 'day',
							count: 7,
							text: '7d'
						}, 
						{
							type: 'day',
							count: 3,
							text: '3d'
						},
						{
							type: 'day',
							count: 1,
							text: '1d'
						},
						{
							type: 'all',
							text: 'All'
						}
						],
						selected: 2
					},

					xAxis: {
						ordinal: false
					},

					yAxis: {
						title: {
							text: 'PSI'
						},

						plotBands: [
						{
							from: 0,
							to: 50,
							color: 'rgba(0, 255, 0, 0.7)',
							label: { text: 'Good' }
						},
						{
							from: 51,
							to: 100,
							color: 'rgba(128, 255, 0, 0.7)',
							label: { text: 'Moderate' }
						},
						{
							from: 101,
							to: 200,
							color: 'rgba(255, 255, 0, 0.7)',
							label: { text: 'Unhealthy' }
						},
						{
							from: 201,
							to: 300,
							color: 'rgba(255, 128, 0, 0.7)',
							label: { text: 'Very unhealthy' }
						},
						{
							from: 301,
							to: 500,
							color: 'rgba(255, 0, 0, 0.7)',
							label: { text: 'Hazardous' }
						}
						]

					},

					series: [
					series24hrpsi,		// put the columnrange series first or the chart won't move on dynamic update
					{
						name: '3-hr PSI Reading',
						id: 'psi3hr',
						data: data,
					}
					]
				});

				//initialize PSI display field with latest value
				psi3_last = data[ data.length - 1 ];
				$('#psi3hr').html(psi3_last[1]);

				//initialize 3 hour PSI update time
				var psi3_update = new Date( psi3_last[0] );
				$('#psi3hr-update-time').html( 'At ' + psi3_update.format('ga \\o\\n d M Y') );

			});

			$.getJSON('http://cosine.dyndns-web.com/psi/psijson.php?query=pm25-all&callback=?', function( data ) {
				pm25chart = new Highcharts.StockChart({
					chart: {
						renderTo: 'pm25_container',
						events: {
							//set up updating of the pm25 chart every min
							load: function() {
								setInterval( updatePM25, 60000 );
							}
						}
					},
					rangeSelector: {
						selected: 1
					},

					legend: {
						enabled: true,
						align: 'center',
						verticalAlign: 'bottom',
						borderWidth: 2,
						itemMarginBottom: 10,
					},

					xAxis: {
						ordinal: false
					},

					yAxis: {
						title: {
							text: 'Concentration (&micro;g/m<sup>3</sup>)',
							useHTML: true
						},
					},

					rangeSelector: {
						buttons: [
						{
							type: 'day',
							count: 7,
							text: '7d'
						}, 
						{
							type: 'day',
							count: 3,
							text: '3d'
						},
						{
							type: 'day',
							count: 1,
							text: '1d'
						},
						{
							type: 'all',
							text: 'All'
						}
						],
						selected: 2
					},

					series: [
					{
						name: '24-hr PM2.5 Concentration',
						id: 'pm25',
						type: 'columnrange',
						data: data
					},
					]
				});

				//initialize PM2.5 display field with latest value
				pm25_last = data[ data.length - 1 ];
				$('#pm25').html(pm25_last[1] + "-" + pm25_last[2] + " (&micro;g/m<sup>3</sup>)");

				//initialize PM2.5 update time field
				var pm25_update = new Date( pm25_last[0] );
				$('#pm25-update-time').html( 'At ' + pm25_update.format('ga \\o\\n d M Y') );

			});
		
			function updatePSI() {
				$.getJSON('http://cosine.dyndns-web.com/psi/psijson.php?query=psi3hr-last&callback=?', function( data ) {
					series3hr = psichart.get( 'psi3hr' );
					if ( data[0] > series3hr.xData[ series3hr.xData.length - 1 ] ) {
						series3hr.addPoint( data, true, true );

						//also update PSI display field
						$('#psi3hr').html( data[1] );

						//update PSI update time field
						var psi3_update = new Date( data[0] );
						$('#psi3hr-update-time').html( 'At ' + psi3_update.format('ga \\o\\n d M Y') );
					}
				});

				$.getJSON('http://cosine.dyndns-web.com/psi/psijson.php?query=psi24hr-last&callback=?', function( data ) {
					series24hrpsi = psichart.get( 'psi24hr' );
					if ( data[0] > series24hrpsi.xData[ series24hrpsi.xData.length - 1 ] ) {
						series24hrpsi.addPoint( data, true, true );
					}

				});

			}

			function updatePM25() {
				$.getJSON('http://cosine.dyndns-web.com/psi/psijson.php?query=pm25-last&callback=?', function( data ) {
					seriespm25 = pm25chart.get( 'pm25' );
					if ( data[0] > seriespm25.xData[ seriespm25.xData.length - 1] ) {
						seriespm25.addPoint( data, true, true );

						//also update PM2.5 display field
						$('#pm25').html( data[1] + "-" + data[2] + " (&micro;g/m<sup>3</sup>)");

						//update PM2.5 update time field
						var pm25_update = new Date( data[0] );
						$('#pm25-update-time').html( 'At ' + pm25_update.format('ga \\o\\n d M Y') );
					}
				});
			}


		});
		</script>

	</head>

	<body>
		<div class="container">
			<div class="row">
				<!-- PSI data -->
				<div class="span6">
					<div class="row">
						<h5 style="text-align: center">3 hour PSI</h5>
					</div>
					<div class="row">
						<h1 id="psi3hr" style="text-align: center; font-size: 4.5em; line-height: 80px"></h1>
					</div>
					<div class="row">
						<p id="psi3hr-update-time" style="text-align: center"></p>
					</div>
				</div>

				<!-- PM2.5 data -->
				<div class="span6">
					<div class="row">
						<h5 style="text-align: center">24 hour PM2.5 Concentration</h5>
					</div>
					<div class="row">
						<h1 id="pm25" style="text-align: center; font-size: 4.5em; line-height: 80px;"></h1>
					</div>
					<div class="row">
						<p id="pm25-update-time" style="text-align: center"></p>
					</div>
				</div>
			</div>

			<!-- graphs --> 
			<div class="row">
				<div class="span6" id="psi_container" style="height:400px;"></div>
				<div class="span6" id="pm25_container" style="height:400px;"></div>
			</div>

		</div>
	</body>
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-41948383-1', 'cosine.dyndns-web.com');
	  ga('send', 'pageview');

	</script>
</html>
